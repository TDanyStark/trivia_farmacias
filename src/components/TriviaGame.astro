---
import { URL_BASE } from '@/config';
import questions from '../data/questions';
---

<div id="trivia-game-container" data-questions={JSON.stringify(questions)} class="w-full max-w-3xl mx-auto text-white flex flex-col relative overflow-hidden pb-20">
  
  <!-- Header: Progress & Stats -->
  <div id="game-header" class="mb-6 space-y-2">
    <div class="flex justify-between items-end text-sm font-semibold tracking-wide text-pink-200">
      <span id="question-counter">Pregunta 1/{questions.length}</span>
      <span id="attempts-counter">Intentos: 0</span>
    </div>
    <div class="w-full bg-white rounded-full h-3 overflow-hidden border border-purple-abbott/50">
      <div id="progress-bar" class="bg-linear-to-r from-pink-abbott to-purple-abbott h-full rounded-full transition-all duration-500 ease-out" style="width: 0%"></div>
    </div>
  </div>

  <!-- Question Title -->
  <h2 id="question-text" class="text-xl md:text-2xl font-normal mb-6 leading-snug min-h-20">
    <!-- Question injected here -->
  </h2>

  <!-- Main Content Area (Choices or Feedback) -->
  <div id="game-content" class="grow flex flex-col justify-center relative">
    
    <!-- Choices List -->
    <div id="choices-list" class="flex flex-col gap-4 w-full">
      <!-- Buttons injected here -->
    </div>

    <!-- Feedback Card (Hidden by default) -->
    <div id="feedback-card" class="hidden w-full bg-[#7a2c8f] rounded-2xl p-6 md:p-8 text-center shadow-lg border border-purple-400/30 animate-fade-in">
      
      <!-- Icon -->
      <div class="flex justify-center mb-4">
        <div id="feedback-icon-container">
          <!-- SVG Icon injected here -->
        </div>
      </div>

      <!-- Title -->
      <h3 id="feedback-title" class="text-3xl md:text-4xl font-black uppercase mb-2 tracking-wider">
        <!-- RESPUESTA CORRECTA / INCORRECTA -->
      </h3>

      <!-- Message/Explanation -->
      <p id="feedback-message" class="text-lg md:text-xl leading-relaxed mb-8 font-medium">
        <!-- Feedback text -->
      </p>

      <!-- Next Button -->
      <div class="flex justify-end w-full">
        <button id="next-btn" class="group flex items-center gap-2 text-white font-bold text-lg hover:text-pink-300 transition-colors">
          SIGUIENTE
          <img class="inline-block w-16" src={`${URL_BASE}/icons/arrow-abbott.svg`} alt="Siguiente">
        </button>
      </div>
    </div>

    <!-- End Screen (Hidden by default) -->
    <div id="end-screen" class="hidden flex-col items-center justify-center w-full h-full text-center space-y-8 animate-fade-in">
      <div class="text-6xl">ðŸŽ‰</div>
      <h2 class="text-4xl font-bold text-pink-300">Â¡Cuestionario Finalizado!</h2>
      
      <div class="bg-purple-800/50 p-6 rounded-xl w-full max-w-md">
        <p class="text-xl mb-2">Resumen de tu partida:</p>
        <p class="text-2xl font-bold" id="final-score-text"></p>
      </div>

      <button id="restart-btn" class="px-10 py-4 bg-pink-500 hover:bg-pink-600 text-white rounded-full font-bold text-xl shadow-lg hover:shadow-pink-500/50 transition-all transform hover:-translate-y-1">
        Repetir Cuestionario
      </button>
    </div>

  </div>

  <!-- Reference Footer -->
  <div id="reference-footer" class="mt-6 pt-4 text-xs md:text-xs text-purple-200 leading-tight">
    <!-- Reference text injected here -->
  </div>

</div>

<style>
  .animate-fade-in {
    animation: fadeIn 0.3s ease-out forwards;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

  /* Custom scrollbar for reference if needed */
  ::-webkit-scrollbar {
    width: 6px;
  }
  ::-webkit-scrollbar-track {
    background: rgba(0,0,0,0.1); 
  }
  ::-webkit-scrollbar-thumb {
    background: rgba(255,255,255,0.2); 
    border-radius: 3px;
  }
</style>

<script>
  import confetti from 'canvas-confetti';
  import { URL_BASE } from '@/config';

  // Get questions from DOM
  const container = document.getElementById('trivia-game-container')!;
  const questionsData = container.dataset.questions;
  if (!questionsData) {
    throw new Error('Questions data not found');
  }
  const questions = JSON.parse(questionsData);

  // State
  let currentQuestionIndex = 0;
  let attempts = 0; // Total attempts in the game
  let isPerfectRun = true; // Remains true if user never gets a question wrong
  let questionAttempts = 0; // Attempts for the current question

  // DOM Elements
  const questionText = document.getElementById('question-text')!;
  const choicesList = document.getElementById('choices-list')!;
  const feedbackCard = document.getElementById('feedback-card')!;
  const feedbackTitle = document.getElementById('feedback-title')!;
  const feedbackMessage = document.getElementById('feedback-message')!;
  const feedbackIconContainer = document.getElementById('feedback-icon-container')!;
  const nextBtn = document.getElementById('next-btn')!;
  const referenceFooter = document.getElementById('reference-footer')!;
  const progressBar = document.getElementById('progress-bar')!;
  const questionCounter = document.getElementById('question-counter')!;
  const attemptsCounter = document.getElementById('attempts-counter')!;
  const endScreen = document.getElementById('end-screen')!;
  const gameHeader = document.getElementById('game-header')!;
  const gameContent = document.getElementById('game-content')!; // Wrapper for choices/feedback
  const restartBtn = document.getElementById('restart-btn')!;
  const finalScoreText = document.getElementById('final-score-text')!;

  // Icons
  const sadFaceIcon = `
    <img src="${URL_BASE}/images/fail.webp" alt="Incorrecto" class="w-24 h-24 object-contain" />
  `;

  const happyFaceIcon = `
    <img src="${URL_BASE}/images/success.webp" alt="Correcto" class="w-24 h-24 object-contain" />
  `;

  function initGame() {
    currentQuestionIndex = 0;
    attempts = 0;
    isPerfectRun = true;
    questionAttempts = 0;
    
    endScreen.classList.add('hidden');
    endScreen.classList.remove('flex');
    gameHeader.classList.remove('hidden');
    questionText.classList.remove('hidden');
    referenceFooter.classList.remove('hidden');
    choicesList.classList.remove('hidden');
    
    renderQuestion();
    updateStats();
  }

  function updateStats() {
    // Progress bar
    const progress = ((currentQuestionIndex) / questions.length) * 100;
    progressBar.style.width = `${progress}%`;
    
    // Text counters
    questionCounter.textContent = `Pregunta ${currentQuestionIndex + 1}/${questions.length}`;
    attemptsCounter.textContent = `Intentos: ${attempts}`;
  }

  function renderQuestion() {
    const q = questions[currentQuestionIndex];
    questionAttempts = 0; // Reset attempts for this new question

    // Update UI
    questionText.textContent = `${currentQuestionIndex + 1}. ${q.prompt}`;
    referenceFooter.innerHTML = `<strong>Referencia: 1</strong> ${q.reference || ''}`;
    
    // Reset views
    choicesList.innerHTML = '';
    choicesList.classList.remove('hidden');
    feedbackCard.classList.add('hidden');

    // Create choices
    q.choices.forEach((choice: string, index: number) => {
      const btn = document.createElement('button');
      btn.className = `
        w-full text-left p-4 md:p-5 rounded-full border-2 border-pink-400/50 
        hover:bg-pink-500/20 hover:border-pink-400 transition-all duration-200
        text-lg md:text-xl font-medium flex items-center gap-4 group
      `;
      
      // Radio circle indicator
      const radio = document.createElement('span');
      radio.className = "w-6 h-6 rounded-full border-2 border-pink-300 flex-shrink-0 group-hover:bg-pink-400/50";
      
      const text = document.createElement('span');
      text.textContent = choice;

      btn.appendChild(radio);
      btn.appendChild(text);

      btn.onclick = () => handleAnswer(index);
      choicesList.appendChild(btn);
    });
    
    updateStats();
  }

  function handleAnswer(selectedIndex: number) {
    const q = questions[currentQuestionIndex];
    attempts++;
    questionAttempts++;
    updateStats();

    const isCorrect = selectedIndex === q.correctIndex;

    if (!isCorrect) {
      // If wrong, we mark perfect run as false
      isPerfectRun = false;
      showFeedback(false);
    } else {
      // If correct
      showFeedback(true);
    }
  }

  function showFeedback(isCorrect: boolean) {
    const q = questions[currentQuestionIndex];
    
    choicesList.classList.add('hidden');
    feedbackCard.classList.remove('hidden');

    if (isCorrect) {
      feedbackTitle.textContent = "RESPUESTA CORRECTA";
      feedbackTitle.className = "text-3xl md:text-4xl font-black uppercase mb-2 tracking-wider text-pink-300";
      feedbackMessage.textContent = q.feedbackCorrect;
      feedbackIconContainer.innerHTML = happyFaceIcon;
    } else {
      feedbackTitle.textContent = "RESPUESTA INCORRECTA";
      feedbackTitle.className = "text-3xl md:text-4xl font-black uppercase mb-2 tracking-wider text-pink-300";
      feedbackMessage.textContent = q.feedbackIncorrect; // Usually "Â¡Intenta de nuevo!"
      feedbackIconContainer.innerHTML = sadFaceIcon;
    }
  }

  nextBtn.onclick = () => {
    // If we are on the feedback screen
    // Check if it was a correct answer or incorrect
    // If incorrect, we should probably let them try again? 
    // The prompt says: "cuando llegue al 10 debe aparecer un boton para repetir el cuestionario"
    // And "si resuelve las preguntas en 1 intento por pregunta se dispare un confetti"
    // This implies they must eventually get it right to proceed.
    
    // Let's check the current state.
    // If the feedback was "Incorrect", usually in these games you go back to the question to try again.
    // BUT the image for incorrect has a "SIGUIENTE" button too.
    // If I click "Siguiente" on incorrect, do I go to the next question (skipping) or retry?
    // The feedback says "Â¡Intenta de nuevo!".
    // So "Siguiente" on incorrect screen might mean "Go back to question".
    
    const q = questions[currentQuestionIndex];
    const isCurrentlyCorrect = feedbackTitle.textContent?.includes("CORRECTA") && !feedbackTitle.textContent?.includes("INCORRECTA");

    if (!isCurrentlyCorrect) {
      // It was incorrect. Go back to choices.
      feedbackCard.classList.add('hidden');
      choicesList.classList.remove('hidden');
    } else {
      // It was correct. Move to next question.
      if (currentQuestionIndex < questions.length - 1) {
        currentQuestionIndex++;
        renderQuestion();
      } else {
        finishGame();
      }
    }
  };

  function finishGame() {
    gameHeader.classList.add('hidden');
    questionText.classList.add('hidden');
    choicesList.classList.add('hidden');
    feedbackCard.classList.add('hidden');
    referenceFooter.classList.add('hidden');
    
    endScreen.classList.remove('hidden');
    endScreen.classList.add('flex');
    
    finalScoreText.textContent = `Intentos totales: ${attempts}`;

    if (isPerfectRun) {
      triggerConfetti();
    }
  }

  function triggerConfetti() {
    const duration = 3000;
    const animationEnd = Date.now() + duration;
    const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 0 };

    const randomInRange = (min: number, max: number) => Math.random() * (max - min) + min;

    const interval = setInterval(function() {
      const timeLeft = animationEnd - Date.now();

      if (timeLeft <= 0) {
        return clearInterval(interval);
      }

      const particleCount = 50 * (timeLeft / duration);
      confetti({
        ...defaults, 
        particleCount,
        origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
      });
      confetti({
        ...defaults, 
        particleCount,
        origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
      });
    }, 250);
  }

  restartBtn.onclick = initGame;

  // Start
  initGame();

</script>